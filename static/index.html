<!doctype html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link type="text/css" rel="stylesheet" href="css/normalize.css"    media="screen,projection"/>
<link type="text/css" rel="stylesheet" href="css/font-awesome.css" media="screen,projection"/>
<link type="text/css" rel="stylesheet" href="css/archimedes.css"   media="screen,projection"/>

<script type="text/javascript" src="js/jquery-2.2.3.js"></script>
<script type="text/javascript" src="js/underscore.js"></script>
<script type="text/javascript" src="js/moment.js"></script>
<script type="text/javascript" src="js/backbone.js"></script>
<script type="text/javascript" src="js/archimedes.js"></script>
<script type="text/javascript" src="js/mousetrap.js"></script>
<script type="text/javascript" src="js/react.min.js"></script>
<script type="text/javascript" src="js/react-dom.min.js"></script>
<script type="text/javascript" src="js/browser.min.js"></script>

<script type="text/babel">
const Actions = {showResource: showResource, toggleFavorite:toggleFavorite};

function showResource(data) {
	dispatcher.publish({
		event: "SHOW_RESOURCE_CONTENTS",
		data
	});
}

function toggleFavorite(data) {
	dispatcher.publish({
		event: "TOGGLE_FAVORITE",
		data
	});
}

class Dispatcher {
	constructor () {
		this.subscriptions = []
	}
	subscribe (func) {
		this.subscriptions.push(func)
	}
	publish (payload) {
		this.subscriptions.map(function (func) {
			func(payload);
		});
	}
}

let dispatcher = new Dispatcher();

class Store {
	constructor () {
		this.listeners = {}
		dispatcher.subscribe(this.eventHandler.bind(this))
		this.resources = new archimedes.Collections.Resources();
		this.resources.url = "/resources/";
		this.resources.on("sync", function (collection, resources) {
			this.emit("sync", resources);
		}.bind(this));
		this.resources.fetch();
		setInterval(function () {
			this.resources.fetch();
		}.bind(this), 10000);
	}
	emit (event, data) {
		this.listeners[event].map(action => action(data))
	}
	on (event, action) {
		this.listeners[event] = this.listeners[event] || [];
		this.listeners[event].push(action);
	}
	off (event, action) {
		this.listeners.pop(this.listeners.indexOf(action));
	}
	eventHandler (event) {
		if (event.event == "SHOW_RESOURCE_CONTENTS") {
			this.emit("show", event.data)
		} else if (event.event == "TOGGLE_FAVORITE") {
			//const model = this.resources.get(event.data.ID);
			//model.set({Favorited:!model.get("Favorited")});

			const data = this.resources.models.map(m => m.attributes)
			data[269]['Favorited'] = true;
			this.emit("sync", data)
		}
	}
}

let resourceStore = new Store();

class ResourceEntry extends React.Component {
	constructor () {
		super();
		this.state = {};
		this.showResource = this.showResource.bind(this);
		this.toggleFav = this.toggleFav.bind(this);
	}
	showResource (ev) {
		if (ev.ctrKey) {
			Actions.showResource(this.state);
		} else {
			Actions.showResource(this.state);
		}
	}
	toggleFav (ev) {
		Actions.toggleFavorite(this.state)
		ev.stopPropagation()
	}
	componentWillMount () {
		this.setState(this.props.data)
	}
	render () {
		if (this.state.ID == 269){
			console.log("Rendering 269 with state: ", this.props.data.Favorited)
		}
		const favicon = this.state.Favorited ? "fa fa-heart" : "fa fa-heart-o";
		const title = this.state.Title || this.state.URL;
		return (
			<li className="noselect" onClick={this.showResource}>
				<i className={favicon} onClick={this.toggleFav}></i>
				<span>{title}</span>
			</li>
		);
	}
}

class ListControls extends React.Component {
	render () {
		return (
			<span></span>
		);
	}
}

class Navigation extends React.Component {
	constructor () {
		super();
		this.state = {};
	}
	updateTitle (data) {
		this.setState(data);
	}
	componentWillMount() {
		resourceStore.on("show", this.updateTitle.bind(this))
	}
	render () {
		return (
			<nav>
				<img src="images/archimedes_head.png"></img>
				<span>Archimedes</span>
				<span id="contentTitle">{this.state.Title}</span>
			</nav>
		);
	}
}

class ResourceList extends React.Component {
	constructor () {
		super();
		this.state = {data:[]};
		this.sync = this.sync.bind(this);
	}
	componentWillMount() {
		resourceStore.on("sync", this.sync)
	}
	componentWillUmount() {
		resourceStore.off("sync", this.sync)
	}
	sync (resources) {
		this.setState({data:resources});
	}
	render () {
		const data = this.state['data'].reverse();
		const resources = data.map((info,i) => <ResourceEntry data={info} key={i} />);
		return (
		<div id="ResourceList">
			<ListControls />
			<ul>
				{resources}
			</ul>
		</div>);
	}
}

class ResourceContents extends React.Component {
	constructor() {
		super();
		this.state = {}
	}
	updateContents(data) {
		this.setState(data);
	}
	componentWillMount() {
		resourceStore.on("show", this.updateContents.bind(this))
	}
	render () {
		return (
		<div id="ResourceContents">
			<iframe src={this.state.LocalURL}>
			</iframe>
		</div>);
	}
}

class Archimedes extends React.Component {
	render() {
		return (
			<div>
				<Navigation />
				<ResourceList />
				<ResourceContents />
			</div>
		);
	}
}

ReactDOM.render(
	<Archimedes />,
	document.getElementById('archimedes')
)

</script>

<title>Archimedes</title>
</head>

<body>

<div id="archimedes"> </div>

</body>

</html>
